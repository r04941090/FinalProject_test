<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://unpkg.com/vue@next"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
    integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <link rel="stylesheet" href="/css/Chat.css">
  <link rel="stylesheet" href="/css/ContextMenu.css">
  <script src="//cdn.jsdelivr.net/npm/element-plus"></script>

  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
</head>

<body>
  <div id="app">
    <div class="room" ref="room">
      <div v-for="content in chatData" :key="content.PostDate">
        <div class="message-date-box">
          <span class="message-date">{{content.PostDate}}</span>
        </div>
        <template v-for="(item, index) in content.MessageBox" :key="index">
          <message-box :chat-data="item" @select-message="getSelectMessage"></message-box>
        </template>
        
      </div>
      <div class="context-menu" :class="{active: menuShow}" ref="contextMenu" id="delete" @click="deleteSelectMessage">
        <div class="item">
          <i class="fas fa-trash-alt" style="margin-right: 7px;"></i> 刪除
        </div>
      </div>
    </div>
    <div class="enter-message">
      <input type="text" class="message" placeholder="請輸入...">
      <button type="button" class="send btn btn-sm btn-success">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  <script>
    const messageBox = {
      data(){
        return {
          contextMenuShow: false,
          selectMessage: ''
        }
      },
      template: `
      <div class="messageBox" v-if="chatData.CurrentUserName !== chatData.UserName">
        <div class="messageBox-photo">
          <img :src="chatData.UserImage" :title="chatData.UserName">
        </div>
        <div class="messageBox-info-left">
          <div class="bubble-arrow-left"></div>
          <div class="messageBox-name">{{chatData.UserName}}</div>
          <div class="messageBox-message" v-for="(message, index) in chatData.TotalMessage" :key="message.CommentId">
            <div class="messageBox-message-left">{{message.Message}}</div>
            <div class="messageBox-time-left" v-if="index == chatData.TotalMessage.length - 1">
              {{chatData.PostType}} {{chatData.PostTime}}
            </div>
          </div>
        </div>
      </div>
      <div class="messageBox-self" v-else>
        <div class="messageBox-info-right">
          <div class="bubble-arrow-right"></div>
          <div class="messageBox-message" v-for="(message, index) in chatData.TotalMessage" :key="message.CommentId" @contextmenu.prevent="showMenu(message, $event)">
            <div class="messageBox-time-right">
              <div class="read" style="text-align: right;">已讀 {{message.ReadQuantity}}</div>
              <span v-if="index == chatData.TotalMessage.length - 1">
                {{chatData.PostType}} {{chatData.PostTime}}
              </span>
            </div>
            <div class="messageBox-message-right">{{message.Message}}</div>
          </div>
        </div>
      </div>`,
      props: ['chatData'],
      emits: ['selectMessage'],
      methods: {
        showMenu(message, event){
          this.$emit('selectMessage', message, event)
        },
      },
      watch:{
        chatData:{
          handler: function(){
            console.log(this.chatData);
          }
        }
      }
    }
    const App = {
      data() {
        return {
          chatData: [],
          selectMessage: '',
          menuShow: false
        }
      },
      methods: {
        deleteSelectMessage(){
          console.log(this.selectMessage);
          
        },
        getChatData() {
          let url = 'https://raw.githubusercontent.com/r04941090/FileStorage/master/ChatData'
          axios.get(url).then(res => {
            console.log(res);
            this.chatData = res.data
            console.log(this.chatData);
            this.$refs.room.scrollTop = this.$refs.room.scrollHeight
            this.$nextTick(() => {
              // https://iter01.com/581627.html
              console.log(this.$refs.room.scrollTop, this.$refs.room.scrollHeight);
              this.$refs.room.scrollTop = this.$refs.room.scrollHeight
            });
          })
        },
        getSelectMessage(message, event){
          this.menuShow = true
          let contextElement = this.$refs.contextMenu
          contextElement.style.top = event.y + "px";
          contextElement.style.left = event.x + "px";
          this.selectMessage = message
        },
        clearSelectMessage(e){
          this.menuShow = false
        }
      },
      
      components: {
        messageBox
      },
      mounted() {
        this.getChatData()
        window.addEventListener('click', this.clearSelectMessage)
      },
    }
    Vue.createApp(App).use(ElementPlus).mount('#app')
  </script>
</body>

</html>