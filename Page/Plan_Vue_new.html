<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
    integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCW6Ekw5sZ0JUZfzpMeSteJ6_8aoQRwfws&libraries=places"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <link rel="stylesheet" href="/css/Plan.css">
  <link rel="stylesheet" href="/css/PlanPage_button.css">
  <link rel="stylesheet" href="/css/Plan_Day.css">
  <script src="https://unpkg.com/vue@next"></script>
</head>

<body ref="body">
  <div class="temp-header"></div>
  <div class="outside position-relative" id="app">
    <div id="map" ref="map"></div>
    <div class="trip-list border" v-show="showTripList" ref="tripList">
      <div class="trip-list-header-info" ref="tripListHeaderInfo">
        <div class="trip-list-header-back">
          <a href=""></a>
        </div>
        <div class="trip-list-header-content">
          <!-- component -->
          <div class="trip-list-header-title-container">
            <input type="text" class="trip-list-header-title edit-mode" v-model="rawData.TripTitle" v-if="edit">
            <div class="trip-list-header-title" v-if="!edit">{{rawData.TripTitle}}</div>
          </div>
          <div class="trip-list-header-date">
            <input type="date" v-model="StartDate" v-if="edit">
            <span v-if="!edit" style="margin-bottom: 2px; display: inline-block;">{{StartDateDisplay}}</span> -
            {{EndDate}}
          </div>
          <div class="trip-list-member">
            <a href="">
              <div class="member-img">
                <!-- 修改 -->
                <img :src="rawData.UserImg" alt="" :title="rawData.UserName">
              </div>
            </a>
          </div>
          <div class="trip-list-header-edit">
            <span class="me-2" @click="edit = !edit">編輯</span>
            <div class="onoffswitch d-inline-block">
              <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" tabindex="0"
                checked v-model="edit">
              <label class="onoffswitch-label" for="myonoffswitch">
                <span class="onoffswitch-inner"></span>
                <span class="onoffswitch-switch"></span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="trip-list-header-day-container" :style="{'height': tripListHeight}" ref="tripListHeaderDayContainer">
        <div class="day-cell"></div>
      </div>
      <div class="trip-list-day-container" ref="tripListDayContainer">
        <div class="trip-item" v-for="(TripContent, index) in rawData.TripContent" :key="TripContent.Id"
          :data-id="TripContent.Id" @mousedown="DragMouseDown">
          <day :trip-content="TripContent" v-if="index == 0" @select-day="selectDay" :show-day="showSpecificRoute"
            :edit="edit" @select-time="selectTime">
          </day>
          <place-gps :trip-content="TripContent" v-else-if="TripContent.Type == 'Place'" @copy-data="copyPlace"
            @delete-place="getDeletePlace" :edit="edit">
          </place-gps>
          <day-plus :trip-content="TripContent" v-else-if="TripContent.Type == 'Day'" @select-day="selectDay"
            :show-day="showSpecificRoute" @select-time="selectTime" :edit="edit"></day-plus>
        </div>
        <div class="trip-item" :data-id="rawData.length + 1">
          <div class="add-venue">
            {{selectDayTime}}
            <span>+ 新增景點</span>
          </div>
        </div>
      </div>
    </div>
    <div class="comments-minimized">
      <i class="far fa-comment-alt"></i>
      <div class="comments-minimized-count">
        6
      </div>
    </div>
    <div class="tool-button-wrapper">
      <div class="tool-button">
        <i class="far fa-copy trip-tools-icon mx-2"></i>
        <div>複製行程</div>
      </div>
      <div class="tool-button">
        <i class="far fa-share-square trip-tools-icon mx-2"></i>
        <div>分享</div>
      </div>
      <div class="tool-button">
        <i class="fas fa-sign-in-alt trip-tools-icon mx-2"></i>
        <div>嵌入地圖</div>
      </div>
    </div>
    <div class="trip-tools-footer">
      <div class="trip-tools-block">
        <i class="far fa-copy trip-tools-icon"></i>
        <span class="trip-tools-content">複製行程</span>
      </div>
      <div class="trip-tools-block">
        <i class="far fa-share-square trip-tools-icon"></i>
        <span class="trip-tools-content">分享行程</span>
      </div>
      <div class="trip-tools-block">
        <i class="far fa-comment-alt trip-tools-icon"></i>
        <span class="trip-tools-content">留言</span>
      </div>
      <div class="trip-tools-block border" @click="showTripList=!showTripList">
        <i class="fas fa-map-marked-alt trip-tools-icon"></i>
        <span class="trip-tools-content">顯示地圖</span>
      </div>
    </div>
    <div class="modal fade" id="Time" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered d-flex justify-centent-center" style="max-width: 300px">
        <div class="modal-content">
          <div class="modal-body edit-time-box">
            <div class="start-time" style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">出發時間：</div>
            <div class="d-flex justify-content-center">
              <select class="form-select mx-1" aria-label="Default select example" v-model="selectDayTime.Type">
                <option value="上午">上午</option>
                <option value="下午">下午</option>
              </select>
              <select class="form-select" v-model="selectDayTime.hour">
                <option :value="hour" v-for="hour in hours">{{hour}}</option>
              </select>
              <div class="mx-2 d-flex align-items-center">
                <span>:</span>
              </div>
              <select class="form-select" v-model="selectDayTime.minute">
                <option :value="minute" v-for="minute in minutes">{{minute}}</option>
              </select>
            </div>
          </div>
          <div class="modal-footer" style="border: none;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" style="background: #ee3c77; border: none;"
              data-bs-dismiss="modal" @click="updateDayStartTime">完成</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <template id="Card">
    <div class="place-card"
      style="font-size: 12px; transform: translateY(0px); background-color: #fff; transition-duration: 10ms">
    </div>
  </template>
  <template id="gps">
    <div class="gps">
      <div class="gps-content">
        <div class="gps-mode-car">
          <img src="/image/car.png" alt="" class="h-100">
        </div>
        <div class="gps-time">
          約
          <span>7分</span>
        </div>
        <div class="gps-go ms-auto">
          <i class="fas fa-angle-double-right"></i>
        </div>
      </div>
    </div>
  </template>

  <script>
    const day = {
      template: `
      <header class="trip-list-day-header">
        <div class="text-white weekday" :style="{background: (showDay.content !== tripContent) && showDay.show  ? '#888' : tripContent.Color}" style="cursor: pointer" @click="selectDay">
          <div class="d-inline-block eye" v-if="showDay.show">
            <i class="far fa-eye" v-if="showDay.content == tripContent"></i>
            <i class="far fa-eye-slash" v-else></i>
          </div>
          <span>第{{tripContent.Day}}天：{{tripContent.Weekday}}</span>
        </div>
        <div class="trip-list-day-header-time">
          出發時間：
          <b class="edit-mode" data-bs-toggle="modal" data-bs-target="#Time" v-if="edit" @click="selectTime">{{tripContent.StartTime}}</b>
          <b v-else >{{tripContent.StartTime}}</b>
        </div>
      </header>`,
      props: ['tripContent', 'showDay', 'edit'],
      emit: ['selectDay', 'selectTime'],
      methods: {
        selectDay() {
          this.$emit('selectDay', this.tripContent)
        },
        selectTime() {
          this.$emit('selectTime', this.tripContent)
        }
      }
    }
    const placeGps = {
      template: `
      <div class="trip-list-venu-container" :class="{'edit': edit}">
        <div class="drag-handler" v-if="edit"></div>
        <div class="trip-list-day-venu-time">
          <span class="trip-list-day-venu-time-from">{{tripContent.StartTime}}</span>
          <span class="fas fa-map-marker trip-list-day-venu-number-mark" :style="{color: tripContent.Color}">
            <span class="trip-list-day-venu-number">{{tripContent.Sequence}}</span>
          </span>
          <span class="trip-list-day-venu-time-to">{{tripContent.EndTime}}</span>
        </div>
        <div class="trip-list-day-venu-info">
          <div class="trip-list-day-venu-info-detail">
            <div class="trip-list-day-venu-info-time" @click=Show>
              <i class="fas fa-clock" style= "color: #888;" v-if="!edit"></i>
              {{tripContent.StayTime}}</div>
            <div class="trip-list-day-venu-info-name">{{tripContent.PlaceName}}</div>
            <div class="trip-list-day-venu-info-address">{{tripContent.Address}}</div>
          </div>
          <div class="trip-list-day-venu-info-edit">
            <div class="position-relative" v-if="edit">
              <i class="far fa-copy copy-tool" @click="$emit('copyData', tripContent)"></i>
              <div class="trip-list-day-venu-info-edit-func">複製</div>
            </div>
            <div class="position-relative" @click="deletePlace" v-if="edit">
              <i class="fas fa-trash delete-tool"></i>
              <div class="trip-list-day-venu-info-edit-func">刪除</div>
            </div>
            <div>
              <i class="fas fa-file-alt" style="font-size: 20px; color: #666;" v-if="!edit"></i>
            </div>
          </div>
        </div>
      </div>
      <div v-if="tripContent.Car">
        <div class="gps">
          <div class="gps-content">
            <div class="gps-mode-car">
              <img src="/image/car.png" alt="" class="h-100">
            </div>
            <div class="gps-time">
              約
              <span>{{tripContent.Car}}</span>
            </div>
            <div class="gps-go ms-auto">
              <i class="fas fa-directions"></i>
            </div>
          </div>
        </div>
      </div>`,
      // template: `<p>{{tripContent.Day}}</p>`,
      props: ['tripContent', 'edit'],
      emits: ['copyData', 'deletePlace'],
      methods: {
        Show() { },
        deletePlace() {
          this.$emit('deletePlace', this.tripContent)
        }
      },
    }

    const dayPlus = {
      data() {
        return {
          show: ''
        }
      },
      template: `
      <div class="add-venue" style="margin-top: 16px;">
        <span>+ 新增景點</span>
      </div>
      <header class="trip-list-day-header">
        <div class="text-white weekday" style="cursor: pointer;" :style="{background: (showDay.content !== tripContent) && showDay.show ? '#888' : tripContent.Color}" @click="selectDay">
          <div class="d-inline-block eye" v-if="showDay.show">
            <i class="far fa-eye" v-if="showDay.content == tripContent"></i>
            <i class="far fa-eye-slash" v-else></i>
          </div>
          <span>第{{tripContent.Day}}天 : {{tripContent.Weekday}}</span>
        </div>
        <div class="trip-list-day-header-time">
          出發時間：
          <b class="edit-mode" data-bs-toggle="modal" data-bs-target="#Time" v-if="edit" @click="selectTime">{{tripContent.StartTime}}</b>
          <b v-else>{{tripContent.StartTime}}</b>
        </div>
      </header>`,
      props: ['tripContent', 'showDay', 'edit'],
      emit: ['selectDay', 'selectTime'],
      methods: {
        selectDay() {
          this.$emit('selectDay', this.tripContent)
        },
        selectTime() {
          console.log(this.tripContent.StartTime);
          this.$emit('selectTime', this.tripContent)
        }
      }
    }

    const App = {
      data() {
        return {
          hours: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
          minutes: ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'],
          showSpecificRoute: {
            show: false,
            content: {}
          },
          selectStartTime: '',
          selectDayTime: {
            Type: '',
            DayId: '',
            hour: '',
            minute: ''
          },
          StartDate: '',
          EndDate: '',
          StartDateDisplay: '',

          tripListHeight: '',
          edit: false,
          setReturn: false,
          showTripList: true,
          map: '',
          directionsService: '',
          directionsRenderersData: [],
          markersData: [],
          placeCard: '',

          tripItems: [],
          tripContainer: '',
          y: 0,
          interval_y: '', // 鼠標移動的距離
          clientY: 0, // 之前的滑鼠鼠標位置
          selectBottom: 0, // 選定區域的底部
          selectTop: 0, // 選定區域的頂部
          H: 0, // 判斷是否要移動的卡片高度，up (id - 1)；down (id + 1)

          ChangeData: {
            old: '',
            new: ''
          },
          clickTag: '',
          mouseMove: '',
          steps: [],
          mouseDirection: '',
          scrollDirection: '',
          totalD: '', // trip-list-day-container的高度
          selectD: '', // 選定漂浮區塊距離trip-list上方的高度
          selectL: '', // 選定區塊的高度 (translateY的距離)
          stopCardMove: '', // 漂浮區塊停止移動，卷軸開始移動
          stopScroll: '', // 停止Scroll bar移動
          timeId: 0, // TimeInterval Id
          scrollTarget: '', // scroll bar移動的目標終點
          scrollInterval: '', // scroll bar移動距離
          currentId: '', // 目前選定的ID
          clickId: '',
          rawData: {}
        }
      },
      methods: {
        getData() {
          let url = "https://raw.githubusercontent.com/r04941090/FileStorage/master/Trip"
          axios.get(url).then(res => {
            this.rawData = res.data
            let StartDateAry = this.rawData.StartDate.split('-')
            let EndDateAry = this.rawData.EndDate.split('-')
            this.StartDate = this.rawData.StartDate
            this.StartDateDisplay = `${StartDateAry[0]}年${StartDateAry[1]}月${StartDateAry[2]}日`
            console.log(this.StartDateDisplay);

            this.EndDate = `${EndDateAry[0]}年${EndDateAry[1]}月${EndDateAry[2]}日`
            this.calculateRoute(this.rawData.TripContent)
          })
        },
        updateDayStartTime() {
          if (this.selectDayTime.Type == '下午') {
            this.selectDayTime.hour = this.selectDayTime.hour + 12
          }
          let selectIndex = this.rawData.TripContent.findIndex(x => x.DayId == this.selectDayTime.DayId && x.Type == 'Day')
          let origin_hour = parseInt(this.rawData.TripContent[selectIndex].StartTime.split(':')[0])
          let origin_minute = parseInt(this.rawData.TripContent[selectIndex].StartTime.split(':')[1])
          let diff = (this.selectDayTime.hour * 60 + parseInt(this.selectDayTime.minute)) - (origin_hour * 60 + origin_minute)
          this.rawData.TripContent.forEach(item => {
            if (item.DayId == this.selectDayTime.DayId) {
              let start_hour = parseInt(item.StartTime.split(':')[0])
              let start_minute = parseInt(item.StartTime.split(':')[1])
              let start_totalMinute = ((start_hour * 60) + start_minute) + diff
              item.StartTime = `${(Math.floor(start_totalMinute / 60)).toString().padStart(2, '0')}:${(start_totalMinute % 60).toString().padStart(2, '0')}`
              if (item.Type == 'Place') {
                // 只有Type為Place才有EndTime
                let end_hour = parseInt(item.EndTime.split(':')[0])
                let end_minute = parseInt(item.EndTime.split(':')[1])
                let end_totalMinute = ((end_hour * 60) + end_minute) + diff
                item.EndTime = `${(Math.floor(end_totalMinute / 60)).toString().padStart(2, '0')}:${(end_totalMinute % 60).toString().padStart(2, '0')}`
              }
            }
          })
        },
        selectTime(select) {
          this.selectStartTime = select
          let selectTime = select.StartTime.split(':')
          let hour = selectTime[0]
          let minute = selectTime[1]
          if (parseInt(hour) - 12 < 0) {
            this.selectDayTime.Type = '上午'
          }
          else {
            this.selectDayTime.Type = '下午'
          }
          this.selectDayTime.DayId = select.DayId
          this.selectDayTime.hour = parseInt(hour)
          this.selectDayTime.minute = minute.toString()
        },
        selectDay(select) {
          if (this.rawData.TripContent.find(x => x.Day == select.Day && x.Type == 'Place') !== undefined) {
            if (this.showSpecificRoute.content == '') {
              this.showSpecificRoute.content = select
              this.showSpecificRoute.show = true
            }
            else {
              if (this.showSpecificRoute.content == select) {
                this.showSpecificRoute.content = ''
                this.showSpecificRoute.show = false
              }
              else {
                this.showSpecificRoute.content = select
                this.showSpecificRoute.show = true
              }
            }
            this.ResetRoute(this.map);
          }
        },
        getDeletePlace(place) {
          console.log(place);
        },
        DragMouseDown(e) {
          this.clickTag = e.target.parentNode.parentNode
          this.tripItems = document.querySelectorAll('.trip-item');
          document.querySelector('.trip-list-header-info');

          // console.dir(this.$refs.tripList)
          // console.dir(document.querySelector('.trip-list-header-info'));
          // console.dir(document.querySelector('.trip-list-header-day-container'));
          // console.dir(document.querySelector('.trip-list-day-container'));

          // 點到drag-handle才有用
          if (e.target.classList[0] == "drag-handler") {
            this.clickTag.style.visibility = 'hidden'
            this.clickTag.style.opacity = 0;

            let template = document.querySelector('#Card');
            cloneNode = template.content.cloneNode(true)
            this.placeCard = cloneNode.querySelector('.place-card')

            // https://emn178.pixnet.net/blog/post/95297028
            let top = this.clickTag.offsetTop + this.$refs.tripList.offsetTop - this.tripContainer.scrollTop + 'px';

            // 要加上目前scroll bar的高度
            // https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect
            let left = this.clickTag.offsetLeft + this.$refs.tripList.offsetLeft + 'px'
            let width = this.clickTag.clientWidth + 2 + 'px'
            let dataID = this.clickTag.dataset.id
            // 將目前點選的元件資訊放入template中
            this.placeCard.style.top = top
            this.placeCard.style.left = left
            this.placeCard.style.width = width
            this.placeCard.dataset.id = dataID
            this.currentId = dataID
            this.placeCard.style['z-index'] = 99
            this.placeCard.innerHTML = this.clickTag.innerHTML

            // 初始化參數
            this.scrollTarget = this.tripContainer.scrollTop
            console.log(this.tripContainer.scrollTop);

            this.selectL = this.clickTag.clientHeight // 選定卡片的高度
            // offsetTop(為選定物件 "頂部" 到父層 "頂部" 的距離) + offsetHeight為選定物件到父層 "頂部" 的距離
            // SelectH = offsetTop - 上面兩塊的高度
            console.log(this.clickTag.offsetTop);

            this.selectD = this.clickTag.offsetTop - this.$refs.tripListHeaderDayContainer.clientHeight - this.$refs.tripListHeaderInfo.clientHeight + this.selectL - this.tripContainer.scrollTop
            console.log('選定物件底部到父層頂部的距離', this.selectD);

            this.totalD = this.tripContainer.offsetHeight; // trip-list-day-container的高度
            this.H = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId) + 1}"]`).offsetHeight
            this.clickId = dataID
            this.selectTop = 0
            this.selectBottom = 0
            this.clientY = 0
            this.y = 0
            this.scrollInterval = 0;
            // this.FirstId = this.tripItems[0].dataset.id
            // this.LastId = this.tripItems[this.tripItems.length - 1].dataset.id;

            this.tripContainer.appendChild(cloneNode);

            this.tripItems.forEach(trip => {
              trip.style.transform = "translateY(0px)";
            })

            window.addEventListener('mousemove', this.updateMove)
            window.addEventListener('mouseup', this.updateCard)
          }
        },
        updateCard() {
          clearInterval(this.timeId)
          this.timeId = 0
          window.removeEventListener('mousemove', this.updateMove)
          window.removeEventListener('mouseup', this.updateCard)
          this.clickTag.style.visibility = 'visible'
          this.clickTag.style.opacity = 1;

          // https://www.gushiciku.cn/pl/p9ck/zh-tw
          if (this.steps.length !== 0) {
            let itemGroups_sort = Object.values(this.tripItems).sort((a, b) => a.dataset.id - b.dataset.id)
            // tripListDayContainer.innerHTML = ''
            itemGroups_sort.forEach(trip => {
              this.tripContainer.appendChild(trip)
              trip.style = ''
              // 渲染畫面
            })
            // 深層複製
            let result = JSON.parse(JSON.stringify(this.rawData.TripContent))
            console.log(result);
            // return
            // 只交換有動到的部分
            console.log(this.steps);

            this.steps.forEach(step => {
              let newIndex = result.findIndex(x => x.Id == step.new);
              let oldIndex = result.findIndex(x => x.Id == this.clickId)
              let tempData1 = result[oldIndex]
              let tempData2 = result[newIndex]
              result[newIndex] = tempData1
              result[oldIndex] = tempData2
            })
            console.log(JSON.parse(JSON.stringify(result)));

            // return
            // 更新Sequence
            let Day, DayId, Sequence, Color
            let Id = (this.tripItems[0].dataset.id) * 50;

            result.forEach(item => {
              if (item.Type == "Day") {
                Day = item.Day
                DayId = item.DayId
                Sequence = 0
                Color = item.Color
              }
              else {
                item.Day = Day
                item.DayId = DayId
                Sequence = Sequence + 1
                item.Sequence = Sequence
                item.Color = Color
              }
              item.Id = Id
              Id = Id + 1
            })
            this.tripItems[this.tripItems.length - 1].dataset.id = Id;
            this.calculateRoute(result);
            this.tripItems.forEach(trip => {
              trip.style.transitionDuration = '10ms'
              trip.style.transform = "translateY(0px)"
              trip.style = ''
            })
            // this.LastId = result[result.lendth - 1]
            // this.FirstId = result[0]
            this.tripContainer.removeChild(this.placeCard)
          }
          else {
            // 沒動
            this.tripContainer.removeChild(this.placeCard)
            this.tripItems.forEach(trip => {
              trip.style = ''
            })
          }
          this.steps = []
          this.tripItems.forEach(trip => {
            trip.style = ''
          })
          // this.$refs.tripListDayContainer.removeChild(this.placeCard)
        },
        ResetRoute(map) {
          if (this.showSpecificRoute.content.Day == undefined) {
            if (this.markersData.length !== 0) {
              this.markersData.forEach(markerData => {
                markerData.marker.setVisible(true)
              })
            }
            if (this.directionsRenderersData.length !== 0) {
              this.directionsRenderersData.forEach(directionsRendererData => {
                directionsRendererData.directionsRenderer.setMap(null)
              })
              this.directionsRenderersData.forEach(directionsRendererData => {
                this.directionsService = new google.maps.DirectionsService();
                this.directionsService.route({
                  origin: {
                    query: directionsRendererData.origin
                  },
                  destination: directionsRendererData.destination,
                  waypoints: directionsRendererData.waypoint,
                  travelMode: google.maps.TravelMode.DRIVING,
                  provideRouteAlternatives: false
                }, function (res, status) {
                  directionsRendererData.directionsRenderer.setOptions({
                    map: map
                  })
                  directionsRendererData.directionsRenderer.setDirections(res);
                })
              })
            }
          }
          else {
            if (this.markersData.length !== 0) {
              this.markersData.forEach(markersData => {
                if (markersData.DayId == this.showSpecificRoute.content.DayId) {
                  markersData.marker.setVisible(true)
                }
                else {
                  markersData.marker.setVisible(false)
                }
              })
            }
            if (this.directionsRenderersData.length !== 0) {
              this.directionsRenderersData.forEach(directionsRendererData => {
                directionsRendererData.directionsRenderer.setMap(null)
              })
              this.directionsRenderersData.forEach(directionsRendererData => {
                if (directionsRendererData.DayId == this.showSpecificRoute.content.DayId) {
                  this.directionsService.route({
                    origin: {
                      query: directionsRendererData.origin
                    },
                    destination: directionsRendererData.destination,
                    waypoints: directionsRendererData.waypoint,
                    travelMode: google.maps.TravelMode.DRIVING,
                    provideRouteAlternatives: false
                  }, function (res, status) {
                    directionsRendererData.directionsRenderer.setOptions({
                      map: map
                    })
                    directionsRendererData.directionsRenderer.setDirections(res);
                  })
                }
                else {
                  directionsRendererData.directionsRenderer.setMap(null)
                }
              })
            }
          }
        },
        calculateRoute(result) {
          // 移除marker、direction
          if (this.markersData.length !== 0) {
            this.markersData.forEach(markersData => {
              // marker.setIcon(null)
              // marker.setLabel(null);
              // marker.setMap(null)
              markersData.marker.setVisible(false)
            })
            this.markersData = []
          }
          if (this.directionsRenderersData.length !== 0) {
            this.directionsRenderersData.forEach(directionsRendererData => {
              directionsRendererData.directionsRenderer.setMap(null)
            })
          }
          let SortPlaceData = []
          let PlaceData = {
            DayId: '',
            Places: [],
            Color: ''
          }
          result.forEach((item, index) => {
            if (item.Type == "Day") {
              if (PlaceData.DayId !== '') {
                SortPlaceData.push(PlaceData)
                PlaceData = {
                  DayId: '',
                  Places: [],
                  Color: ''
                }
              }
              PlaceData.DayId = item.DayId
              PlaceData.Color = item.Color
            }
            else {
              PlaceData.Places.push(item.PlaceName)
              if (index == result.length - 1) {
                SortPlaceData.push(PlaceData)
              }
            }
          })
          SortPlaceData.forEach(item => {
            if (item.Places.length > 1) {
              let start_location = item.Places.shift() // 移除第一個
              let end_location = item.Places.pop() // 移除最後一個
              let WayPoints = []
              item.Places.forEach(waypoint => {
                WayPoints.push({
                  location: waypoint,
                  stopover: true
                })
              })
              let CalulateResult = {
                DayId: '',
                Address: [],
                CarTime: []
              }
              this.calculateAndDisplayRoute(start_location, end_location, WayPoints, item.Color, this.map, this.pinSymbol, this.markLabel, item.DayId).then(res => {
                CalulateResult.DayId = item.DayId
                res.routes[0].legs.forEach((result, index) => {
                  CalulateResult.Address.push(result.start_address.slice(3, -1))
                  if (index == res.routes[0].legs.length - 1) {
                    CalulateResult.Address.push(result.end_address.slice(3, -1))
                  }
                  CalulateResult.CarTime.push(result.duration.text)
                })
                let DayStartTime = 0
                result.filter(x => x.DayId == CalulateResult.DayId && x.Type == "Place").forEach((selected, index) => {
                  selected.Address = CalulateResult.Address[index]

                  if (index == 0) {
                    DayStartTime = result.filter(x => x.DayId == CalulateResult.DayId && x.Type == "Day")[0].StartTime
                  }
                  let StartDateAry = this.rawData.StartDate.split('-')
                  let datetime = new Date(StartDateAry[0], StartDateAry[1], StartDateAry[2], DayStartTime.split(':')[0], DayStartTime.split(':')[1])
                  let stay_hour = 0;
                  let stay_minute = 0;
                  if (selected.StayTime.split(' ').length == 1) {
                    // 沒有小時
                    stay_hour = 0
                    stay_minute = parseInt(selected.StayTime.split('分')[0])
                  }
                  else {
                    stay_hour = parseInt(selected.StayTime.split(' ')[0].split('小時')[0])
                    stay_minute = parseInt(selected.StayTime.split(' ')[1].split('分')[0])
                  }
                  let EndTime = new Date(datetime.getTime() + (stay_hour * 60 + stay_minute) * 60000)
                  selected.StartTime = this.changeDateFormat(datetime)
                  selected.EndTime = this.changeDateFormat(EndTime)
                  if (CalulateResult.CarTime.length == index) {
                    // 最後一個景點
                    selected.Car = ''
                    // 日期替換
                  }
                  else {
                    // 加入Car的時間
                    selected.Car = CalulateResult.CarTime[index]
                    // 日期替換
                    let car_hour = 0;
                    let car_minute = 0;
                    if (CalulateResult.CarTime[index].split(' ').length == 2) {
                      // 沒有小時
                      car_hour = 0
                      car_minute = parseInt(CalulateResult.CarTime[index].split(' ')[0])
                    }
                    else {
                      car_hour = parseInt(CalulateResult.CarTime[index].split(' ')[0])
                      car_minute = parseInt(CalulateResult.CarTime[index].split(' ')[2])
                    }
                    let AddCarTime = new Date(datetime.getTime() + ((car_hour + stay_hour) * 60 + (car_minute + stay_minute)) * 60000)
                    DayStartTime = this.changeDateFormat(AddCarTime)
                  }
                })
                this.rawData.TripContent = JSON.parse(JSON.stringify(result))
              })
            }
            else if (item.Places.length == 1) {
              // 只有一個地點
              let DayStartTime = result.filter(x => x.DayId == item.DayId && x.Type == "Day")[0].StartTime
              let StartDateAry = this.rawData.StartDate.split('-')
              let datetime = new Date(StartDateAry[0], StartDateAry[1], StartDateAry[2], DayStartTime.split(':')[0], DayStartTime.split(':')[1])
              let selected = result.filter(x => x.DayId == item.DayId && x.Type == "Place")[0]
              let stay_hour = 0;
              let stay_minute = 0;
              if (selected.StayTime.split(' ').length == 1) {
                // 沒有小時
                stay_hour = 0
                stay_minute = parseInt(selected.StayTime.split('分')[0])
              }
              else {
                stay_hour = parseInt(selected.StayTime.split(' ')[0].split('小時')[0])
                stay_minute = parseInt(selected.StayTime.split(' ')[1].split('分')[0])
              }
              let EndTime = new Date(datetime.getTime() + ((stay_hour) * 60 + stay_minute) * 60000)
              selected.StartTime = this.changeDateFormat(datetime)
              selected.EndTime = this.changeDateFormat(EndTime)
              selected.Car = ''
              this.findPlace(item.DayId, item.Places[0], this.markLabel, selected, item.Color).then(res => {
                this.rawData.TripContent = JSON.parse(JSON.stringify(result))
              })
            }
          })
        },
        copyPlace(place) {
          console.log(place);
          let insertIndex = this.rawData.TripContent.findIndex(x => x.Id = place.Id)
        },
        findPlace(DayId, Place, markLabel, selected, color) {
          return new Promise((resolve, reject) => {
            let request = {
              query: Place,
              fields: ['ALL']
            }
            let PlacesService = new google.maps.places.PlacesService(this.map);
            PlacesService.findPlaceFromQuery(request, function (results, status) {
              selected.Address = results[0].formatted_address.slice(3, -1)
              console.log(results[0]);

              markLabel(DayId, results[0].geometry.location, color, "1", "900")
              resolve('success')
            })
          })

        },
        changeDateFormat(datetime) {
          let result = {
            hour: datetime.getHours().toString().padStart(2, 0),
            minute: datetime.getMinutes().toString().padStart(2, 0)
          }
          return `${result.hour}:${result.minute}`
        },

        calculateAndDisplayRoute(origin, destination, waypoint, routeColor, map, pinSymbol, markLabel, DayId) {
          this.directionsService = new google.maps.DirectionsService();
          // A service for computing directions between two or more places.
          let directionsRenderer = new google.maps.DirectionsRenderer({
            // Renders directions obtained from the DirectionsService.
            map: map,
            suppressMarkers: true,
            // suppressPolylines: true,
            polylineOptions: {
              strokeColor: routeColor,
              strokeOpacity: 0.6,
              strokeWeight: 5
            },
          })
          let directionsRendererData = {
            directionsRenderer: directionsRenderer,
            DayId: DayId,
            origin: origin,
            destination: destination,
            waypoint: waypoint,
            routeColor: routeColor,
          }
          this.directionsRenderersData.push(directionsRendererData)
          return new Promise((resolve, reject) => {
            this.directionsService.route({
              origin: {
                query: origin
              },
              destination: destination,
              waypoints: waypoint,
              travelMode: google.maps.TravelMode.DRIVING,
              provideRouteAlternatives: false
            }, function (res, status) {

              directionsRenderer.setDirections(res);
              // draw marker
              let my_route = res.routes[0]
              let Places = []
              my_route.legs.forEach(item => {
                Places.push(item.start_location)
              })
              Places.push(my_route.legs[my_route.legs.length - 1].end_location)
              let fontWeight = 'normal'
              for (var i = 0; i < Places.length; i++) {
                if (i == 0 || i == Places.length - 1) {
                  fontWeight = '900'
                }
                else {
                  fontWeight = '400'
                }
                markLabel(DayId, Places[i], routeColor, (i + 1).toString(), fontWeight)
              }
              resolve(res)
            })
          })
        },
        markLabel(DayId, Place, color, labelText, fontWeight) {
          let map = this.map
          let icon = this.pinSymbol(color)
          let position = JSON.parse(JSON.stringify(Place))

          let label = {
            text: labelText,
            color: 'black',
            fontSize: '12px',
            fontWeight: fontWeight
          }
          const image =
            "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png";
          let marker = new google.maps.Marker({
            position: position,
            label: label,
            map: map,
            optimized: true,
            icon: icon
          })
          let markerData = {
            marker: marker,
            DayId: DayId
          }
          this.markersData.push(markerData)
        },
        pinSymbol(color) {
          return {
            path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
            fillColor: color,
            fillOpacity: 0.8,
            strokeColor: '#000',
            strokeWeight: 2,
            // border
            scale: 1,
            labelOrigin: new google.maps.Point(0, -29)
          };
        },
        updateMove(e) {
          this.checkMouseDirection(e)
          // 漂浮卡片移動
          this.placeCard.style.transform = `translateY(${this.y}px)`
          if (this.mouseDirection == 'down') {
            this.selectD = this.selectD + this.interval_y  // 有可能超出畫面

            // 如果滑鼠有移動，則需要修改
            // if (this.stopScroll){
            //   this.selectBottom = this.selectBottom + this.interval_y
            //   this.selectTop = this.selectTop - this.interval_y
            // }
            this.selectBottom = this.selectBottom + this.interval_y
            this.selectTop = this.selectTop - this.interval_y

            if (!this.checkTripScrollDirection()) {
              console.log('要移動的區塊 down', this.H);
              console.log('selectBottom', this.selectBottom, 'selectTop', this.selectTop);
              // 代表沒有滑動到底部
              if (!this.stopMove) {
                if (this.selectBottom > this.H / 2) {
                  this.changeData(this.mouseDirection)
                }
              }
            }
          }
          else if (this.mouseDirection == 'up') {
            // 在底部，然後scroll bar往下移動，但鼠標是往上
            this.selectD = this.selectD - this.interval_y

            // 如果滑鼠有移動，則需要修改
            // if (this.stopScroll) {
            //   this.selectTop = this.selectTop + this.interval_y
            //   this.selectBottom = this.selectBottom - this.interval_y
            // }
            this.selectTop = this.selectTop + this.interval_y
            this.selectBottom = this.selectBottom - this.interval_y

            if (!this.checkTripScrollDirection()) {
              console.log('要移動的區塊 up', this.H);
              console.log('selectBottom', this.selectBottom, 'selectTop', this.selectTop);
              if (!this.stopMove) {
                if (this.selectTop > this.H / 2) {
                  this.changeData(this.mouseDirection)
                }
              }
            }
          }
          // else {

          //   this.checkTripScrollDirection()
          // }
        },
        addSteps() {
          if (this.steps.length !== 0) {
            // 檢查是否移回原位
            if (this.steps[this.steps.length - 1].old == this.ChangeData.new &&
              this.steps[this.steps.length - 1].new == this.ChangeData.old) {
              // 移除最後一個
              this.steps.pop()
            }
            else {
              this.steps.push(JSON.parse(JSON.stringify(this.ChangeData)))
            }
          }
          else {
            this.steps.push(JSON.parse(JSON.stringify(this.ChangeData)))
          }
          console.log(this.steps);
        },
        changeData(direction) {
          if (direction == 'up') {
            let changeNode = this.tripContainer.querySelector(`[data-id="${this.currentId}"]`)
            if (changeNode.style.transform == 'translateY(0px)' ||
              changeNode.style.transform == `translateY(${this.selectL}px)`) {
              let moveNode = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId) - 1}"]`)
              moveNode.style.transform = `translateY(${this.selectL}px)`
              this.currentId = parseInt(this.currentId) - 1
            }
            else if (changeNode.style.transform == `translateY(${this.selectL * (-1)}px)`) {
              let moveNode = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId)}"]`)
              moveNode.style.transform = `translateY(0px)`
              this.currentId = parseInt(this.currentId) - 1
            }
            this.stopScroll = false
            console.log('this.H', this.H);


            // if (!this.stopMove) {
            //   this.selectBottom = this.H - this.selectTop
            //   this.selectTop = (this.H - this.selectTop) * (-1)
            // }
            this.selectBottom = this.H - this.selectTop
            this.selectTop = (this.H - this.selectTop) * (-1)
            console.log('new selectTop', this.selectTop, 'new selectBottom', this.selectBottom);
            // alert('test')
            this.ChangeData.old = parseInt(this.currentId) + 1
            this.ChangeData.new = parseInt(this.currentId)
            this.addSteps();
          }
          else if (direction == 'down') {
            let changeNode = this.tripContainer.querySelector(`[data-id="${this.currentId}"]`)
            if (changeNode.style.transform == 'translateY(0px)' ||
              changeNode.style.transform == `translateY(${this.selectL * (-1)}px)`) {
              let moveNode = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId) + 1}"]`)
              moveNode.style.transform = `translateY(${this.selectL * (-1)}px)`
              this.currentId = parseInt(this.currentId) + 1
            }
            else if (changeNode.style.transform == `translateY(${this.selectL * (-1)}px)`) {
              let moveNode = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId)}"]`)
              moveNode.style.transform = `translateY(0px)`
              this.currentId = parseInt(this.currentId) + 1
            }
            this.stopScroll = false
            console.log('this.H', this.H);

            // if (!this.stopMove) {
            //   this.selectTop = this.H - this.selectBottom
            //   this.selectBottom = (this.H - this.selectBottom) * (-1)
            // }
            this.selectTop = this.H - this.selectBottom
            this.selectBottom = (this.H - this.selectBottom) * (-1)
            console.log('new selectTop', this.selectTop, 'new selectBottom', this.selectBottom);
            // alert('test')
            this.ChangeData.old = parseInt(this.currentId) - 1
            this.ChangeData.new = parseInt(this.currentId)
            this.addSteps();
          }
        },
        checkMouseDirection(e) {
          // 監測鼠標位置
          if (this.clientY !== 0) {
            let changeNode = this.tripContainer.querySelector(`[data-id="${this.currentId}"]`)
            if (this.clientY > e.clientY) {
              this.mouseDirection = 'up'
              this.updateNextH(this.mouseDirection)
              this.interval_y = this.clientY - e.clientY
              this.y = this.y - this.interval_y
            }
            else if (this.clientY < e.clientY) {
              this.mouseDirection = 'down'
              // 判斷接下來要確認的H、是否stopMove
              this.updateNextH(this.mouseDirection)
              this.interval_y = e.clientY - this.clientY
              this.y = this.y + this.interval_y
            }
            else {
              this.mouseDirection = 'same'
            }
          }
          // 記錄前一次數值用於下次比較
          this.clientY = e.clientY
        },
        updateNextH(direction) {
          let changeNode = this.tripContainer.querySelector(`[data-id="${this.currentId}"]`)
          if (direction == "down") {
            if (changeNode.style.transform == 'translateY(0px)' ||
              changeNode.style.transform == `translateY(${this.selectL * (-1)}px)`) {
              if (parseInt(this.currentId) + 1 == this.tripItems[this.tripItems.length - 1].dataset.id) {
                this.stopMove = true
              }
              else {
                this.stopMove = false
                this.H = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId) + 1}"]`).offsetHeight
              }
            }
            else if (changeNode.style.transform == `translateY(${this.selectL}px)`) {
              this.H = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId)}"]`).offsetHeight
              this.stopMove = false
            }
          }
          else if (direction == "up") {
            if (changeNode.style.transform == 'translateY(0px)' ||
              changeNode.style.transform == `translateY(${this.selectL}px)`) {
              if (parseInt(this.currentId) - 1 == this.tripItems[0].dataset.id) {
                this.stopMove = true
              }
              else {
                this.stopMove = false
                this.H = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId) - 1}"]`).offsetHeight
              }
            }
            else if (changeNode.style.transform == `translateY(${this.selectL * (-1)}px)`) {
              this.H = this.tripContainer.querySelector(`[data-id="${parseInt(this.currentId)}"]`).offsetHeight
              this.stopMove = false
            }
          }
        },
        scrollMove() {
          console.log('ssssss', this.stopScroll);

          // https://developer.mozilla.org/en-US/docs/Web/API/Element/scroll
          // scroll information
          if (this.scrollDirection == 'down') {
            if (!this.stopScroll) {
              this.scrollInterval = this.scrollInterval + 1
              this.scrollTarget = this.scrollTarget + this.scrollInterval
              // let option = {
              //   top: this.scrollTarget,
              //   behavior: 'auto'
              // }
              // console.log(option);

              this.tripContainer.scroll(0, this.scrollTarget)

              if (this.tripContainer.scrollTop + this.tripContainer.clientHeight >= this.tripContainer.scrollHeight) {
                // 代表到底部
                this.stopScroll = true
                this.scrollTarget = this.tripContainer.scrollTop
                this.scrollInterval = 0
                // clearTimeInterval
                clearInterval(this.timeId)
                this.timeId = 0
              }
              else {
                this.stopScroll = false
                this.selectBottom = this.selectBottom + this.scrollInterval
                this.selectTop = this.selectTop - this.scrollInterval
                // 檢查下一個H
                this.updateNextH(this.scrollDirection)
                console.log(this.selectBottom, this.selectTop);

                if (!this.stopMove) {
                  if (this.selectBottom > this.H / 2) {
                    console.log(this.selectBottom, this.selectTop, this.H);
                    this.scrollInterval = 0
                    this.changeData(this.scrollDirection)
                    // alert('AAAAAA')
                  }
                }
              }
            }
          }
          else if (this.scrollDirection == 'up') {
            if (!this.stopScroll) {
              this.scrollInterval = this.scrollInterval + 1
              this.scrollTarget = this.scrollTarget - this.scrollInterval
              this.tripContainer.scroll(0, this.scrollTarget)
              if (this.tripContainer.scrollTop == 0) {
                // 代表到頂
                this.stopScroll = true
                this.scrollTarget = 0
                this.scrollInterval = 0
                // clearTimeInterval
                clearInterval(this.timeId)
                this.timeId = 0
              }
              else {
                this.stopScroll = false
                this.selectBottom = this.selectBottom - this.scrollInterval
                this.selectTop = this.selectTop + this.scrollInterval
                // 檢查下一個H
                this.updateNextH(this.scrollDirection)
                if (!this.stopMove) {
                  if (this.selectTop > this.H / 2) {
                    this.scrollInterval = 0
                    this.changeData(this.scrollDirection)
                  }
                }
              }
            }
          }
        },
        checkTripScrollDirection() {
          let result
          console.log(this.selectD, this.totalD);
          // console.log(this.currentDirection, 'first');

          // 用非同步的方式觸發
          if (this.selectD > this.totalD) {
            // 到達trip-list底部，並且scroll bar開始滑動
            if (this.tripContainer.scrollTop + this.tripContainer.clientHeight >= this.tripContainer.scrollHeight) {
              // 到達底部後要把stopScroll改成true
              this.stopScroll = true
              this.scrollTarget = 0
              this.scrollInterval = 0
              // clearTimeInterval
              clearInterval(this.timeId)
              this.timeId = 0
              result = false
            }
            else {
              this.scrollDirection = 'down'
              this.stopScroll = false
              result = true
            }
          }
          else if (this.selectD < this.selectL) {
            // 到達trip-list頂部，並且scroll bar開始滑動
            if (this.tripContainer.scrollTop == 0) {
              // 到達頂部後要把stopScroll改成true
              this.stopScroll = true
              this.scrollTarget = 0
              this.scrollInterval = 0
              // clearTimeInterval
              clearInterval(this.timeId)
              this.timeId = 0
              result = false
            }
            else {
              this.scrollDirection = 'up'
              this.stopScroll = false
              result = true
            }
          }
          else {
            // 停止滾動
            this.stopScroll = true
            result = false
            if (this.stopScroll) {
              if (this.timeId !== 0) {
                clearInterval(this.timeId)
                this.timeId = 0
                console.log(this.timeId);
              }
            }
          }
          if (result) {
            if (this.timeId == 0) {
              this.timeId = setInterval(this.scrollMove, 10)
            }
          }
          return result
        },
        InitMap() {
          this.map = new google.maps.Map(this.$refs.map, {
            zoom: 16,
            center: { lat: 25.0336752, lng: 121.5648831 },
            mapTypeControl: false
            // streetViewControl: false
          })

        },
        TripListShow(e) {
          if (e.target.innerWidth >= 768) {
            this.showTripList = true
          }
        },
        calcTripContainerHeight() {
          let H = this.$refs.tripListHeaderInfo.scrollHeight
          this.tripContainer.style.height = `calc(100% - (${this.$refs.tripListHeaderInfo.scrollHeight + this.$refs.tripListHeaderDayContainer.clientHeight}px)`
        },
      },
      watch: {
        rawData: {
          handler: function (newValue) {
            console.log('watchRawData', newValue);
          },
          deep: true
        },
        edit: {
          handler: function () {
            this.showSpecificRoute = {
              show: false,
              content: {}
            }
            this.calcTripContainerHeight();
          }
        },
        StartDate: {
          handler: function (newValue) {
            let StartDateAry = newValue.split('-')
            let newDate = new Date(StartDateAry[0], StartDateAry[1], StartDateAry[2])
            let EndDate = new Date(newDate.setDate(newDate.getDate() + this.rawData.TotalDate - 1))
            this.StartDateDisplay = `${StartDateAry[0]}年${StartDateAry[1]}月${StartDateAry[2]}日`
            this.EndDate = `${EndDate.getFullYear()}年${EndDate.getMonth()}月${EndDate.getDate()}日`
          }
        }
      },
      components: {
        day,
        placeGps,
        dayPlus
      },

      mounted() {
        // this.FirstId = 1
        // this.LastId = document.querySelectorAll('.trip-item').length;
        this.tripContainer = this.$refs.tripListDayContainer

        this.getData();
        this.InitMap();
        window.addEventListener('resize', this.TripListShow)
        this.calcTripContainerHeight()

      },
      beforeDestroy() {
        window.removeEventListener("resize", this.TripListShow);
      }
    }
    Vue.createApp(App).mount('#app');
  </script>
</body>

</html>